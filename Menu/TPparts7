--[[
    TSRUST | Ohio Mega Hub
    Голубой дизайн, 3D текст, авто-лут, скорость бега, кил-аура, ТП к игрокам
]]--

do
    if _G.TSRUST_LOADED then return warn("[TSRUST] Уже запущен") end
    _G.TSRUST_LOADED = true
end

local ok, Library = pcall(function()
    return loadstring(game:HttpGet("https://raw.githubusercontent.com/1Qlua-RBXscript/1qlua/refs/heads/main/labar"))()
end)
if not ok or not Library then return warn("[TSRUST] UI не загрузилась") end

pcall(function() Library:SetTheme("Ocean") end)

local Players    = game:GetService("Players")
local WS         = game:GetService("Workspace")
local RS         = game:GetService("RunService")
local LP         = Players.LocalPlayer

local State = {
    AutoLoot      = false,
    MoveMode      = "Teleport",
    LootDelay     = 0.2,
    IdleDelay     = 0.5,
    Radius        = 900,
    FlySpeed      = 80,
    SpeedLock     = false,
    SpeedValue    = 16,
    KillAura      = false,
    KillRadius    = 30,
    Follow        = false,
    LoopAll       = false,
    TargetPlayer  = nil,
}

local Items = {
    ["money printer"]           = true,
    ["gold deagle"]             = true,
    ["gold ak-47"]              = true,
    ["gold ak"]                 = true,
    ["scar l"]                  = true,
    ["fn fal"]                  = true,
    ["as val"]                  = true,
    ["military armory keycard"] = true,
    ["mustang key"]             = true,
    ["c4"]                      = true,
    ["emerald"]                 = true,
    ["ruby"]                    = true,
    ["amethyst"]                = true,
    ["diamond"]                 = true,
    ["dark matter gem"]         = true,
    ["treasure chest"]          = true,
    ["treasure map"]            = true,
    ["cash"]                    = true,
    ["money"]                   = true,
}

local ItemDisplay = {}
for k in pairs(Items) do
    local d = k:gsub("^%l", string.upper):gsub("(%s%l)", string.upper)
    ItemDisplay[k] = d
end

-- ==================== УТИЛИТЫ ====================

local function chr()
    local c = LP.Character
    if not c then c = LP.CharacterAdded:Wait() end
    local h = c:FindFirstChild("HumanoidRootPart") or c:WaitForChild("HumanoidRootPart", 5)
    return c, h
end

local function hum()
    local c = LP.Character
    return c and c:FindFirstChildOfClass("Humanoid")
end

local function clearPhysics()
    local c, h = chr()
    if not h then return end
    for _, v in ipairs(h:GetChildren()) do
        if v:IsA("BodyVelocity") or v:IsA("BodyGyro") then v:Destroy() end
    end
end

local function tp(pos)
    local _, h = chr()
    if h then h.CFrame = CFrame.new(pos + Vector3.new(0, 0.5, 0)) end
end

local function flyTo(pos)
    local c, h = chr()
    if not h then return end
    clearPhysics()

    local bv = Instance.new("BodyVelocity")
    bv.MaxForce = Vector3.new(4e4, 4e4, 4e4)
    bv.Velocity = Vector3.new(0, 0, 0)
    bv.P = 1500
    bv.Parent = h

    local bg = Instance.new("BodyGyro")
    bg.MaxTorque = Vector3.new(4e4, 4e4, 4e4)
    bg.P = 3000
    bg.CFrame = h.CFrame
    bg.Parent = h

    local done = false
    local t0 = tick()
    local cn
    cn = RS.Heartbeat:Connect(function()
        if not State.AutoLoot or not h.Parent or tick() - t0 > 12 then
            done = true
            cn:Disconnect()
            return
        end
        local d = pos - h.Position
        if d.Magnitude < 4 then
            done = true
            cn:Disconnect()
            return
        end
        bv.Velocity = d.Unit * math.min(State.FlySpeed, d.Magnitude * 3)
        bg.CFrame = CFrame.new(h.Position, pos)
    end)

    while not done and tick() - t0 < 12 do task.wait() end
    if cn then cn:Disconnect() end
    clearPhysics()
    if h and h.Parent then h.CFrame = CFrame.new(pos + Vector3.new(0, 0.5, 0)) end
end

local function pickup(part)
    if not part or not part.Parent then return end
    local _, h = chr()
    if not h then return end

    local pp = part:FindFirstChildWhichIsA("ProximityPrompt", true)
    if pp then
        if typeof(fireproximityprompt) == "function" then
            fireproximityprompt(pp)
        else
            pp.HoldDuration = 0
            pp:InputHoldBegin()
            task.wait(0.15)
            pp:InputHoldEnd()
        end
    end

    local cd = part:FindFirstChildWhichIsA("ClickDetector", true)
    if cd and typeof(fireclickdetector) == "function" then
        fireclickdetector(cd)
    end

    if typeof(firetouchinterest) == "function" then
        firetouchinterest(h, part, 0)
        firetouchinterest(h, part, 1)
    end
end

local function findLoot()
    local _, h = chr()
    if not h then return nil end
    local best, bestD = nil, State.Radius
    for _, inst in ipairs(WS:GetDescendants()) do
        if inst:IsA("BasePart") and Items[string.lower(inst.Name)] then
            local d = (inst.Position - h.Position).Magnitude
            if d < bestD then bestD = d; best = inst end
        end
    end
    return best
end

-- ==================== ФОНОВЫЕ ЦИКЛЫ ====================

-- Авто-лут
task.spawn(function()
    while task.wait(0.05) do
        if State.AutoLoot then
            local _, h = chr()
            if h then
                local t = findLoot()
                if t and t.Parent then
                    local dest = t.Position + Vector3.new(0, 3, 0)
                    if State.MoveMode == "Fly" then flyTo(dest) else tp(dest) end
                    pickup(t)
                    task.wait(State.LootDelay)
                else
                    task.wait(State.IdleDelay)
                end
            else
                task.wait(1)
            end
        end
    end
end)

-- Скорость бега
task.spawn(function()
    while task.wait(0.15) do
        if State.SpeedLock then
            local h = hum()
            if h then h.WalkSpeed = State.SpeedValue end
        end
    end
end)

-- Кил-аура
task.spawn(function()
    while task.wait(0.15) do
        if State.KillAura then
            local c, h = chr()
            if h then
                local best, bestD = nil, State.KillRadius
                for _, p in ipairs(Players:GetPlayers()) do
                    if p ~= LP then
                        local tc = p.Character
                        local th = tc and tc:FindFirstChild("HumanoidRootPart")
                        local tm = tc and tc:FindFirstChildOfClass("Humanoid")
                        if th and tm and tm.Health > 0 then
                            local d = (th.Position - h.Position).Magnitude
                            if d < bestD then bestD = d; best = th end
                        end
                    end
                end
                if best then
                    h.CFrame = best.CFrame * CFrame.new(0, 1.5, 0)
                    local tool = c:FindFirstChildOfClass("Tool") or LP.Backpack:FindFirstChildOfClass("Tool")
                    if tool and tool.Parent == LP.Backpack then tool.Parent = c end
                    if typeof(mouse1click) == "function" then mouse1click() end
                    if typeof(firetouchinterest) == "function" then
                        firetouchinterest(h, best, 0)
                        firetouchinterest(h, best, 1)
                    end
                end
            end
        end
    end
end)

-- Фоллоу
task.spawn(function()
    while task.wait(0.2) do
        if State.Follow and State.TargetPlayer then
            local p = Players:FindFirstChild(State.TargetPlayer)
            local th = p and p.Character and p.Character:FindFirstChild("HumanoidRootPart")
            local _, h = chr()
            if th and h then h.CFrame = th.CFrame + Vector3.new(0, 3, 0) end
        end
    end
end)

-- Луп по всем
task.spawn(function()
    local i = 1
    while task.wait(0.35) do
        if State.LoopAll then
            local list = {}
            for _, p in ipairs(Players:GetPlayers()) do
                if p ~= LP then table.insert(list, p) end
            end
            if #list > 0 then
                if i > #list then i = 1 end
                local th = list[i].Character and list[i].Character:FindFirstChild("HumanoidRootPart")
                if th then tp(th.Position + Vector3.new(0, 3, 0)) end
                i = i + 1
            end
        end
    end
end)

-- ==================== UI ====================

Library:Watermark("| TSRUST ♡ Ohio Mega Hub |")
local W = Library:Window("| TSRUST ♡ Hub |")

-- Баннер: голубой градиент + белая обводка + 3D текст
pcall(function()
    local gui = game:GetService("CoreGui"):FindFirstChild("RedOnyx")
    if not gui then return end
    local mf = gui:FindFirstChild("MainFrame", true)
    if not mf then return end

    local b = Instance.new("Frame")
    b.Size = UDim2.new(0, 300, 0, 48)
    b.Position = UDim2.new(0, 20, 0, -56)
    b.BackgroundColor3 = Color3.fromRGB(90, 170, 255)
    b.BorderSizePixel = 0
    b.Parent = mf
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 14)

    local s = Instance.new("UIStroke", b)
    s.Thickness = 2.5
    s.Color = Color3.fromRGB(255, 255, 255)

    local g = Instance.new("UIGradient", b)
    g.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0.0, Color3.fromRGB(60, 150, 255)),
        ColorSequenceKeypoint.new(0.4, Color3.fromRGB(190, 225, 255)),
        ColorSequenceKeypoint.new(0.75, Color3.fromRGB(130, 200, 255)),
        ColorSequenceKeypoint.new(1.0, Color3.fromRGB(80, 165, 255)),
    }
    g.Rotation = 12

    -- 3D тень
    local sh = Instance.new("TextLabel", b)
    sh.Size = UDim2.new(1, 0, 1, 0)
    sh.Position = UDim2.new(0, 3, 0, 3)
    sh.BackgroundTransparency = 1
    sh.Text = "TSRUST"
    sh.Font = Enum.Font.GothamBlack
    sh.TextSize = 30
    sh.TextColor3 = Color3.fromRGB(10, 30, 70)

    -- Основной текст
    local tl = Instance.new("TextLabel", b)
    tl.Size = UDim2.new(1, 0, 1, 0)
    tl.BackgroundTransparency = 1
    tl.Text = "TSRUST"
    tl.Font = Enum.Font.GothamBlack
    tl.TextSize = 30
    tl.TextColor3 = Color3.fromRGB(255, 255, 255)

    local ts = Instance.new("UIStroke", tl)
    ts.Thickness = 2
    ts.Color = Color3.fromRGB(180, 220, 255)
end)

W:Section("TSRUST | Ohio")

-- ===== Табы =====
local T1 = W:Tab("Фарм", "dollar-sign")
local T2 = W:Tab("Игрок", "activity")
local T3 = W:Tab("Бой", "sword")
local T4 = W:Tab("Игроки", "users")

-- ===== Фарм =====
local F1 = T1:SubTab("Авто-лут")
local F2 = T1:SubTab("Настройки")

local B1 = F1:Groupbox("Авто-лут Ohio", "Left", "target", "true")

B1:AddParagraph({
    Title = "Сбор ресурсов",
    Content = "Авто ТП/полёт к ближайшему предмету из списка.\nПодбирает через ProximityPrompt, ClickDetector и Touch.\nВ фоне ждёт появления лута если его нет.",
    TextWrapped = true
})

B1:AddToggle({
    Title = "Авто-лут",
    Flag = "TSRUST_Loot",
    Default = false,
    Callback = function(v)
        State.AutoLoot = v
        if not v then clearPhysics() end
        if Library.Notify then Library:Notify("TSRUST", v and "Авто-лут ВКЛ" or "Авто-лут ВЫКЛ", 2) end
    end
})

B1:AddButton({
    Title = "Разовый ТП к ближайшему предмету",
    Callback = function()
        local t = findLoot()
        if not t then
            if Library.Notify then Library:Notify("TSRUST", "Нет предметов рядом", 2) end
            return
        end
        tp(t.Position + Vector3.new(0, 3, 0))
        pickup(t)
        if Library.Notify then Library:Notify("TSRUST", "ТП к: " .. t.Name, 1.5) end
    end
})

local B2 = F1:Groupbox("Предметы", "Right", "list-checks", "true")

for key in pairs(Items) do
    B2:AddCheckbox({
        Title = ItemDisplay[key] or key,
        Default = true,
        Callback = function(v) Items[key] = v end
    })
end

local C1 = F2:Groupbox("Режим", "Left", "navigation", "true")
local C2 = F2:Groupbox("Параметры", "Right", "gauge", "true")

C1:AddDropdown({
    Title = "Режим перемещения",
    Values = {"Телепорт", "Полёт"},
    Default = "Телепорт",
    Callback = function(v)
        State.MoveMode = v == "Полёт" and "Fly" or "Teleport"
    end
})

C1:AddSlider({
    Title = "Скорость полёта",
    Min = 40, Max = 180, Default = 80,
    Callback = function(v) State.FlySpeed = v end
})

C2:AddSlider({
    Title = "Задержка между предметами",
    Min = 0.05, Max = 1.5, Default = 0.2, Rounding = 2, Suffix = " с",
    Callback = function(v) State.LootDelay = v end
})

C2:AddSlider({
    Title = "Пауза если лута нет",
    Min = 0.2, Max = 3.0, Default = 0.5, Rounding = 2, Suffix = " с",
    Callback = function(v) State.IdleDelay = v end
})

C2:AddSlider({
    Title = "Радиус поиска",
    Min = 200, Max = 2500, Default = 900, Suffix = " студ.",
    Callback = function(v) State.Radius = v end
})

-- ===== Игрок =====
local P1 = T2:SubTab("Характеристики")
local PB = P1:Groupbox("Локальный игрок", "Left", "activity", "true")

PB:AddSlider({
    Title = "Скорость бега (WalkSpeed)",
    Min = 8, Max = 150, Default = 16,
    Callback = function(v)
        State.SpeedValue = v
        local h = hum()
        if h then h.WalkSpeed = v end
    end
})

PB:AddToggle({
    Title = "Постоянно лочить WalkSpeed",
    Default = false,
    Callback = function(v) State.SpeedLock = v end
})

-- ===== Бой =====
local K1 = T3:SubTab("Кил-аура")
local KB = K1:Groupbox("Кил-аура", "Left", "sword", "true")

KB:AddParagraph({
    Title = "Как работает",
    Content = "ТП к ближайшему игроку в радиусе, экипирует оружие\nиз рюкзака и пытается нанести урон (touch + click).",
    TextWrapped = true
})

KB:AddToggle({
    Title = "Включить кил-ауру",
    Default = false,
    Callback = function(v)
        State.KillAura = v
        if Library.Notify then Library:Notify("TSRUST", v and "Кил-аура ВКЛ" or "Кил-аура ВЫКЛ", 2) end
    end
})

KB:AddSlider({
    Title = "Радиус",
    Min = 10, Max = 80, Default = 30, Suffix = " студ.",
    Callback = function(v) State.KillRadius = v end
})

-- ===== Игроки =====
local PL1 = T4:SubTab("ТП к игрокам")
local PLL = PL1:Groupbox("Цель", "Left", "user", "true")
local PLR = PL1:Groupbox("Действия", "Right", "users-round", "true")

local function plist()
    local l = {}
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LP then table.insert(l, p.Name) end
    end
    table.sort(l)
    return l
end

PLL:AddDropdown({
    Title = "Игрок",
    Values = plist(),
    Flag = "TSRUST_Target",
    Callback = function(v) State.TargetPlayer = v end
})

local function refreshPlayers()
    local it = Library.Items and Library.Items["TSRUST_Target"]
    if it and it.Refresh then it.Refresh(plist()) end
end

Players.PlayerAdded:Connect(refreshPlayers)
Players.PlayerRemoving:Connect(refreshPlayers)

PLL:AddButton({
    Title = "Обновить список",
    Callback = function()
        refreshPlayers()
        if Library.Notify then Library:Notify("TSRUST", "Список обновлён", 2) end
    end
})

PLR:AddButton({
    Title = "ТП к игроку",
    Callback = function()
        if not State.TargetPlayer then return end
        local p = Players:FindFirstChild(State.TargetPlayer)
        local th = p and p.Character and p.Character:FindFirstChild("HumanoidRootPart")
        if th then tp(th.Position + Vector3.new(0, 3, 0)) end
    end
})

PLR:AddToggle({
    Title = "Фоллоу за игроком",
    Default = false,
    Callback = function(v) State.Follow = v end
})

PLR:AddToggle({
    Title = "ТП по всем по кругу",
    Default = false,
    Callback = function(v) State.LoopAll = v end
})

if Library.Notify then Library:Notify("TSRUST", "Ohio Mega Hub загружен", 3) end
