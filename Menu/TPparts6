--[[
    TSRUST | TP & Loot Hub
    Игра: Ohio (и не только)
    Функции:
      - Авто-ТП и подбор лута по выбранным предметам
      - Бесконечное ожидание: если лута нет, скрипт просто ждёт
      - Режим перемещения: Телепорт / Полёт
      - ТП к игроку, луп‑фоллоу за игроком, ТП по всем игрокам по кругу
      - Красивое меню на библиотеке labar (RedOnyx)
]]--

-- защитa от двойного запуска
pcall(function()
    if getgenv then
        if getgenv().TSRUST_TPpart_LOADED then
            warn("[TSRUST] TPpart уже запущен")
            return
        end
        getgenv().TSRUST_TPpart_LOADED = true
    end
end)

-- Загрузка UI‑библиотеки
local LibraryUrl = "https://raw.githubusercontent.com/1Qlua-RBXscript/1qlua/refs/heads/main/labar"
local ok, Library = pcall(function()
    return loadstring(game:HttpGet(LibraryUrl))()
end)

if not ok or not Library then
    return warn("[TSRUST] Не удалось загрузить UI библиотеку!")
end

---------------------------------------------------------------------
-- СЕРВИСЫ И ПЕРЕМЕННЫЕ
---------------------------------------------------------------------

local Players      = game:GetService("Players")
local Workspace    = game:GetService("Workspace")
local RunService   = game:GetService("RunService")
local UserInput    = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local LocalPlayer  = Players.LocalPlayer

local AutoLootEnabled   = false
local MoveMode          = "Teleport" -- "Teleport" или "Fly"
local LootDelay         = 0.4        -- задержка между предметами
local NoLootDelay       = 1.0        -- задержка, когда предметов нет
local SearchRadius      = 900        -- радиус поиска предметов
local FlySpeed          = 70         -- скорость полёта
local FollowEnabled     = false
local LoopAllEnabled    = false

-- список предметов (имена в нижнем регистре)
local TargetItems = {
    ["money printer"]               = {Display = "Money printer"},
    ["gold deagle"]                 = {Display = "Gold Deagle"},
    ["scar l"]                      = {Display = "SCAR‑L"},
    ["fn fal"]                      = {Display = "FN FAL"},
    ["military armory keycard"]     = {Display = "Military armory keycard"},
    ["mustang key"]                 = {Display = "Mustang key"},
    ["as val"]                      = {Display = "AS VAL"},
}

-- какие предметы включены в фарм
local EnabledTargets = {}
for name in pairs(TargetItems) do
    EnabledTargets[name] = true
end

---------------------------------------------------------------------
-- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
---------------------------------------------------------------------

local function getCharacter()
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp  = char:FindFirstChild("HumanoidRootPart") or char:WaitForChild("HumanoidRootPart", 5)
    if not hrp then return nil, nil end
    return char, hrp
end

local function isTargetNameEnabled(nameLower)
    for key, _ in pairs(TargetItems) do
        if EnabledTargets[key] then
            -- строгие имена, без contains – меньше ложных совпадений
            if nameLower == key then
                return true
            end
        end
    end
    return false
end

-- поиск ближайшего нужного BasePart
local function FindClosestWantedPart()
    local char, hrp = getCharacter()
    if not char or not hrp then return nil end

    local closest, closestDist = nil, SearchRadius

    for _, inst in ipairs(Workspace:GetDescendants()) do
        if inst:IsA("BasePart") then
            local lname = string.lower(inst.Name)
            if isTargetNameEnabled(lname) then
                local dist = (inst.Position - hrp.Position).Magnitude
                if dist < closestDist then
                    closestDist = dist
                    closest = inst
                end
            end
        end
    end

    return closest
end

-- аккуратная очистка физики полёта
local function clearFlight(char, hrp)
    char = char or LocalPlayer.Character
    hrp  = hrp or (char and char:FindFirstChild("HumanoidRootPart"))
    if not char or not hrp then return end

    for _, v in ipairs(hrp:GetChildren()) do
        if v:IsA("BodyVelocity") or v:IsA("BodyGyro") then
            v:Destroy()
        end
    end
end

-- плавный полёт к точке
local function FlyToPosition(targetPos)
    local char, hrp = getCharacter()
    if not char or not hrp then return end

    clearFlight(char, hrp)

    local bv = Instance.new("BodyVelocity")
    bv.MaxForce = Vector3.new(40_000, 40_000, 40_000)
    bv.Velocity = Vector3.new()
    bv.P = 1_500
    bv.Parent = hrp

    local gyro = Instance.new("BodyGyro")
    gyro.MaxTorque = Vector3.new(40_000, 40_000, 40_000)
    gyro.P = 3_000
    gyro.CFrame = hrp.CFrame
    gyro.Parent = hrp

    local reached = false
    local start   = tick()
    local timeout = 10

    local conn
    conn = RunService.Heartbeat:Connect(function(dt)
        if not AutoLootEnabled or not hrp or not hrp.Parent then
            reached = true
            conn:Disconnect()
            return
        end

        local delta = targetPos - hrp.Position
        local dist  = delta.Magnitude

        if dist < 4 then
            reached = true
            conn:Disconnect()
            return
        end

        local dir = delta.Unit
        local speed = math.min(FlySpeed, dist * 3)
        bv.Velocity = dir * speed
        gyro.CFrame = CFrame.new(hrp.Position, targetPos)
    end)

    while not reached and tick() - start < timeout do
        task.wait()
    end

    if conn then conn:Disconnect() end
    clearFlight(char, hrp)
    if (getgenv and AutoLootEnabled) or (not getgenv) then
        pcall(function()
            hrp.CFrame = CFrame.new(targetPos + Vector3.new(0, 0.2, 0))
        end)
    end
end

local function TeleportToPosition(targetPos)
    local _, hrp = getCharacter()
    if not hrp then return end
    hrp.CFrame = CFrame.new(targetPos + Vector3.new(0, 0.2, 0))
end

-- подбор предмета (ProximityPrompt + Touch)
local function TryPickup(target)
    if not target or not target.Parent then return end

    local _, hrp = getCharacter()
    if not hrp then return end

    -- ProximityPrompt
    local prompt = target:FindFirstChildWhichIsA("ProximityPrompt", true)
    if prompt then
        if typeof(fireproximityprompt) == "function" then
            fireproximityprompt(prompt)
        else
            prompt.HoldDuration = 0
            prompt:InputHoldBegin()
            task.wait(0.15)
            prompt:InputHoldEnd()
        end
    end

    -- Touch
    if typeof(firetouchinterest) == "function" then
        firetouchinterest(hrp, target, 0)
        firetouchinterest(hrp, target, 1)
    end
end

---------------------------------------------------------------------
-- ГЛАВНЫЙ ЦИКЛ АВТО‑ЛУТА (БЕЗ ОСТАНОВКИ, ЖДЁТ ПРЕДМЕТЫ)
---------------------------------------------------------------------

task.spawn(function()
    while true do
        if AutoLootEnabled then
            local target = FindClosestWantedPart()
            if target and target.Parent then
                local targetNameLower = string.lower(target.Name)
                local niceName = TargetItems[targetNameLower]
                    and TargetItems[targetNameLower].Display
                    or target.Name

                Library:Notify("TSRUST | Лут", "Найден: " .. niceName, 2)

                local destination = target.Position + Vector3.new(0, 3, 0)

                if MoveMode == "Fly" then
                    FlyToPosition(destination)
                else
                    TeleportToPosition(destination)
                end

                TryPickup(target)
                task.wait(LootDelay)
            else
                -- нет предметов: просто ждём и продолжаем
                task.wait(NoLootDelay)
            end
        else
            task.wait(0.2)
        end
    end
end)

---------------------------------------------------------------------
-- ТП К ИГРОКАМ
---------------------------------------------------------------------

local SelectedPlayerName = nil

local function getPlayerList()
    local list = {}
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            table.insert(list, plr.Name)
        end
    end
    table.sort(list)
    return list
end

local function getSelectedPlayer()
    if not SelectedPlayerName then return nil end
    return Players:FindFirstChild(SelectedPlayerName)
end

local function TeleportToPlayer(plr)
    plr = plr or getSelectedPlayer()
    if not plr then
        Library:Notify("TSRUST | Игроки", "Игрок не выбран", 2)
        return
    end

    local targetChar = plr.Character
    local targetHrp  = targetChar and targetChar:FindFirstChild("HumanoidRootPart")
    if not targetHrp then
        Library:Notify("TSRUST | Игроки", "У игрока нет персонажа", 2)
        return
    end

    local _, hrp = getCharacter()
    if not hrp then return end

    hrp.CFrame = targetHrp.CFrame + Vector3.new(0, 3, 0)
end

-- Луп‑фоллоу за выбранным игроком
task.spawn(function()
    while true do
        if FollowEnabled then
            local plr = getSelectedPlayer()
            local targetChar = plr and plr.Character
            local targetHrp  = targetChar and targetChar:FindFirstChild("HumanoidRootPart")
            local _, hrp = getCharacter()

            if plr and targetHrp and hrp then
                hrp.CFrame = targetHrp.CFrame + Vector3.new(0, 3, 0)
            end

            task.wait(0.25)
        else
            task.wait(0.2)
        end
    end
end)

-- ТП по всем игрокам по кругу
task.spawn(function()
    local index = 1
    while true do
        if LoopAllEnabled then
            local list = getPlayerList()
            if #list == 0 then
                task.wait(1)
            else
                if index > #list then index = 1 end
                local name = list[index]
                local plr  = Players:FindFirstChild(name)
                if plr then
                    TeleportToPlayer(plr)
                end
                index = index + 1
                task.wait(0.4)
            end
        else
            task.wait(0.2)
        end
    end
end)

---------------------------------------------------------------------
-- КРАСИВОЕ МЕНЮ TSRUST
---------------------------------------------------------------------

Library:Watermark("| TSRUST ♡ Ohio TP & Loot |")

local Window = Library:Window("| TSRUST ♡ TP Hub |")

Window:Section("TSRUST | Основное")

-- ТАБЫ
local LootTab    = Window:Tab("Лут", "dollar-sign")
local PlayersTab = Window:Tab("Игроки", "users")
local MiscTab    = Window:Tab("Дополнительно", "settings-2")

---------------------------------------------------------------------
-- ТАБ ЛУТА
---------------------------------------------------------------------

local LootMain   = LootTab:SubTab("Авто‑лут")
local LootConfig = LootTab:SubTab("Настройки")

-- ЛЕВЫЙ ГРУПБОКС: старт/статус
local LootBox = LootMain:Groupbox("Авто‑ТП по предметам", "Left", "target", "true")

LootBox:AddParagraph({
    Title       = "TSRUST | Авто‑лут Ohio",
    Content     = "Скрипт в фоне постоянно ищет нужные предметы.\n" ..
                  "Как только хоть один появляется – вы телепортируетесь\n" ..
                  "или плавно летите к нему и подбираете.",
    TextWrapped = true
})

LootBox:AddToggle({
    Title       = "Включить авто‑лут",
    Description = "Работает в фоновом режиме, ждёт появление лута.",
    Flag        = "TSRUST_AutoLoot",
    Default     = false,
    Callback    = function(state)
        AutoLootEnabled = state
        if state then
            Library:Notify("TSRUST | Лут", "Авто‑лут включён", 2)
        else
            clearFlight()
            Library:Notify("TSRUST | Лут", "Авто‑лут выключен", 2)
        end
    end
})

LootBox:AddButton({
    Title       = "Разовый прыжок к ближайшему луту",
    Description = "Один раз найти ближайший предмет и ТП/полететь к нему.",
    Callback    = function()
        local target = FindClosestWantedPart()
        if not target then
            Library:Notify("TSRUST | Лут", "Сейчас рядом нет подходящих предметов", 2)
            return
        end
        local dest = target.Position + Vector3.new(0, 3, 0)
        if MoveMode == "Fly" then
            FlyToPosition(dest)
        else
            TeleportToPosition(dest)
        end
        TryPickup(target)
        Library:Notify("TSRUST | Лут", "Телепорт к: " .. target.Name, 2)
    end
})

-- ПРАВЫЙ ГРУПБОКС: какие предметы фармить
local FilterBox = LootMain:Groupbox("Какие предметы фармим", "Right", "list-checks", "true")

for key, data in pairs(TargetItems) do
    FilterBox:AddCheckbox({
        Title       = data.Display,
        Description = "Включить/выключить этот предмет в списке авто‑лута.",
        Default     = true,
        Callback    = function(state)
            EnabledTargets[key] = state
        end
    })
end

-- НАСТРОЙКИ ЛУТА
local SettingsLeft  = LootConfig:Groupbox("Режим перемещения", "Left", "navigation", "true")
local SettingsRight = LootConfig:Groupbox("Скорость и задержки", "Right", "gauge", "true")

SettingsLeft:AddDropdown({
    Title   = "Режим движения",
    Values  = {"Телепорт", "Полет"},
    Default = "Телепорт",
    Callback = function(v)
        if v == "Полет" then
            MoveMode = "Fly"
        else
            MoveMode = "Teleport"
        end
        Library:Notify("TSRUST | Лут", "Режим: " .. v, 2)
    end
})

SettingsRight:AddSlider({
    Title       = "Радиус поиска лута",
    Description = "Максимальная дистанция поиска предметов (стандарт 900).",
    Min         = 100,
    Max         = 2000,
    Default     = 900,
    Suffix      = " студ.",
    Callback    = function(v)
        SearchRadius = v
    end
})

SettingsRight:AddSlider({
    Title       = "Задержка между предметами",
    Description = "Пауза после удачного лута.",
    Min         = 0.1,
    Max         = 2.0,
    Default     = 0.4,
    Rounding    = 1,
    Suffix      = " c",
    Callback    = function(v)
        LootDelay = v
    end
})

SettingsRight:AddSlider({
    Title       = "Пауза, если лута нет",
    Description = "Как часто проверять наличие предметов.",
    Min         = 0.3,
    Max         = 3.0,
    Default     = 1.0,
    Rounding    = 1,
    Suffix      = " c",
    Callback    = function(v)
        NoLootDelay = v
    end
})

SettingsRight:AddSlider({
    Title       = "Скорость полёта",
    Description = "Используется в режиме движения 'Полет'.",
    Min         = 30,
    Max         = 150,
    Default     = 70,
    Suffix      = "",
    Callback    = function(v)
        FlySpeed = v
    end
})

---------------------------------------------------------------------
-- ТАБ ИГРОКОВ
---------------------------------------------------------------------

local PlMain = PlayersTab:SubTab("ТП и фоллоу")

local PlLeft  = PlMain:Groupbox("Цель", "Left", "user", "true")
local PlRight = PlMain:Groupbox("Режимы телепортации", "Right", "users-round", "true")

local PlayerDropdown

PlayerDropdown = PlLeft:AddDropdown({
    Title       = "Игрок",
    Values      = getPlayerList(),
    Default     = nil,
    Flag        = "TSRUST_TargetPlayer",
    Description = "Выберите игрока для телепортации.",
    Callback    = function(v)
        SelectedPlayerName = v
        if v then
            Library:Notify("TSRUST | Игроки", "Цель: " .. v, 2)
        end
    end
})

local function refreshPlayerDropdown()
    local item = Library.Items["TSRUST_TargetPlayer"]
    if item and item.Refresh then
        item.Refresh(getPlayerList())
    end
end

Players.PlayerAdded:Connect(refreshPlayerDropdown)
Players.PlayerRemoving:Connect(refreshPlayerDropdown)

PlLeft:AddButton({
    Title       = "Обновить список игроков",
    Description = "Перезаполнить список игроков в дропдауне.",
    Callback    = function()
        refreshPlayerDropdown()
        Library:Notify("TSRUST | Игроки", "Список игроков обновлён", 2)
    end
})

PlRight:AddButton({
    Title       = "ТП один раз к игроку",
    Description = "Мгновенный телепорт к выбранному игроку.",
    Callback    = function()
        TeleportToPlayer()
    end
})

PlRight:AddToggle({
    Title       = "Фоллоу за игроком (луп)",
    Description = "Постоянно телепортироваться к выбранному игроку.",
    Flag        = "TSRUST_FollowPlayer",
    Default     = false,
    Callback    = function(state)
        FollowEnabled = state
        if state then
            Library:Notify("TSRUST | Игроки", "Фоллоу включён", 2)
        else
            Library:Notify("TSRUST | Игроки", "Фоллоу выключен", 2)
        end
    end
})

PlRight:AddToggle({
    Title       = "ТП по всем игрокам по кругу",
    Description = "По очереди телепортируется ко всем игрокам.",
    Flag        = "TSRUST_LoopAllPlayers",
    Default     = false,
    Callback    = function(state)
        LoopAllEnabled = state
        if state then
            Library:Notify("TSRUST | Игроки", "Луп по всем игрокам включён", 2)
        else
            Library:Notify("TSRUST | Игроки", "Луп по всем игрокам выключен", 2)
        end
    end
})

---------------------------------------------------------------------
-- ДОПОЛНИТЕЛЬНЫЙ ТАБ (ИНФО / ХОТКЕИ)
---------------------------------------------------------------------

local InfoBox = MiscTab:SubTab("Инфо"):Groupbox("Информация", "Left", "info", "true")

InfoBox:AddParagraph({
    Title       = "TSRUST | TPpart",
    Content     = "• Авто‑лут по выбранным предметам\n" ..
                  "• Работает в фоне и сам ждёт появление лута\n" ..
                  "• ТП / Полёт к луту\n" ..
                  "• ТП к игрокам, фоллоу, луп по всем",
    TextWrapped = true
})

InfoBox:AddParagraph({
    Title       = "Советы",
    Content     = "— В режиме Ohio некоторые предметы могут иметь немного другие имена.\n" ..
                  "  Если что‑то не ловится – проверь точное имя предмета и напиши мне.\n\n" ..
                  "— Если игра принудительно двигает персонажа, включай режим 'Телепорт'.",
    TextWrapped = true
})

---------------------------------------------------------------------
-- ГОТОВО
---------------------------------------------------------------------

Library:Notify("TSRUST", "TP & Loot Hub загружен", 3)
